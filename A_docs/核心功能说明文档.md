# 智能药盒系统 - 核心功能说明文档

## 项目概述

智能药盒系统是一个基于IoT的智能医疗辅助系统，通过软硬件结合的方式帮助老年人按时服药。系统采用前后端分离架构，通过MQTT协议实现设备与云端的实时通信。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  管理员端    │  │  用户端      │  │  移动端      │        │
│  │  (React)     │  │  (React)     │  │  (可选)      │        │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
└─────────┼──────────────────┼──────────────────┼────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────┐
│                    应用服务层 (后端)                            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Spring Boot 3.2.2 (Java 21)              │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │   │
│  │  │ REST API   │  │  WebSocket │  │ MQTT集成   │     │   │
│  │  └────────────┘  └────────────┘  └────────────┘     │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │   │
│  │  │药品管理    │  │设备管理    │  │通知服务    │     │   │
│  │  └────────────┘  └────────────┘  └────────────┘     │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────────┼────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────┐
│                    消息代理层 (MQTT)                            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Mosquitto MQTT Broker                      │   │
│  │  - 端口: 1883 (MQTT), 9001 (WebSocket)                  │   │
│  │  - 主题: medicinebox/{deviceId}/config/command/status  │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────────┼────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────┐
│                    设备端 (IoT)                                 │
│  ┌──────────────────────┐  ┌──────────────────────────────┐   │
│  │  NodeMCU ESP8266     │  │  Arduino Uno                 │   │
│  │  - WiFi连接          │  │  - 舵机控制                 │   │
│  │  - MQTT通信          │  │  - 蜂鸣器提醒               │   │
│  │  - OLED显示          │  │  - LED指示灯                │   │
│  │  - 时间同步          │  │  - 按钮交互                 │   │
│  └──────────┬───────────┘  └──────────┬───────────────────┘   │
└─────────────┼─────────────────────────┼─────────────────────────┘
              │                         │
              └───────────┬─────────────┘
                          │
┌─────────────────────────┼─────────────────────────────────────┐
│                    数据持久层                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              MySQL 8.0 数据库                            │   │
│  │  - medicines (药品表)                                    │   │
│  │  - users (用户表)                                        │   │
│  │  - offline_events (离线事件表)                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 一、后端核心功能

### 1.1 技术栈
- **框架**: Spring Boot 3.2.2
- **语言**: Java 21
- **数据库**: MySQL 8.0 + JPA/Hibernate
- **消息队列**: MQTT (Eclipse Paho + Spring Integration)
- **实时通信**: WebSocket (STOMP)
- **构建工具**: Maven

### 1.2 核心模块

#### 1.2.1 药品管理模块

**文件位置**: [MedicineController.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/controller/MedicineController.java), [MedicineService.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/service/MedicineService.java)

**核心功能**:
- 药品CRUD操作（创建、读取、更新、删除）
- 药品启用/禁用状态切换
- 按时间排序获取活跃药品列表
- 药品数据验证

**API接口**:
```
GET    /api/medicines              - 获取所有药品
GET    /api/medicines/active       - 获取启用的药品
GET    /api/medicines/{id}         - 获取指定药品
POST   /api/medicines              - 创建新药品
PUT    /api/medicines/{id}         - 更新药品信息
DELETE /api/medicines/{id}         - 删除药品
PATCH  /api/medicines/{id}/toggle  - 切换药品启用状态
```

**药品数据结构**:
```java
{
  "id": 1,
  "name": "降压药",
  "dosage": "1片",
  "hour": 8,
  "minute": 0,
  "boxNum": 1,
  "enabled": true
}
```

#### 1.2.2 MQTT通信模块

**文件位置**: [MqttService.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/service/MqttService.java), [MqttGateway.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/service/MqttGateway.java)

**核心功能**:
- 设备状态管理（在线/离线检测）
- 药品配置同步到设备
- 发送控制命令到设备（打开/关闭药格、测试蜂鸣器）
- 广播消息到所有设备
- 设备心跳检测（60秒超时判定离线）

**MQTT主题设计**:
```
medicinebox/{deviceId}/config    - 配置同步主题
medicinebox/{deviceId}/command   - 命令控制主题
medicinebox/{deviceId}/status    - 设备状态主题
medicinebox/{deviceId}/events   - 事件上报主题
medicinebox/broadcast            - 广播消息主题
```

**设备状态管理**:
- 实时跟踪设备在线状态
- 记录设备最后活跃时间
- 支持离线模式配置
- 统计离线事件数量

#### 1.2.3 通知服务模块

**文件位置**: [NotificationService.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/service/NotificationService.java)

**核心功能**:
- WebSocket实时通知推送
- 服药提醒通知
- 设备在线/离线通知
- 配置同步成功/失败通知
- 通知历史记录管理

**通知类型**:
```java
- MEDICATION_REMINDER  - 服药提醒
- DEVICE_ONLINE       - 设备上线
- DEVICE_OFFLINE      - 设备离线
- CONFIG_SYNC         - 配置同步
- MEDICINE_TAKEN      - 服药确认
- DEVICE_WARNING      - 设备警告
- DEVICE_ERROR        - 设备错误
```

#### 1.2.4 设备事件处理模块

**文件位置**: [DeviceEventService.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/service/DeviceEventService.java)

**核心功能**:
- 设备状态变化事件处理
- 服药提醒事件处理
- 药品服用事件处理
- 设备警告/错误事件处理
- 离线事件记录到数据库

#### 1.2.5 NodeMCU控制模块

**文件位置**: [NodeMCUController.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/controller/NodeMCUController.java)

**核心功能**:
- 获取设备配置（C语言格式）
- 同步药品配置到指定设备
- 发送控制命令到设备
- 获取设备状态列表

**API接口**:
```
GET    /api/nodemcu/config          - 获取设备配置
POST   /api/nodemcu/sync            - 同步配置到设备
POST   /api/nodemcu/command         - 发送命令到设备
GET    /api/nodemcu/devices         - 获取设备列表
```

#### 1.2.6 用户认证模块

**文件位置**: [AuthController.java](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/java/com/ycyu/backend/controller/AuthController.java)

**核心功能**:
- 用户登录/注册
- 角色管理（ADMIN/USER）
- 用户信息查询

### 1.3 配置文件

**文件位置**: [application.properties](file:///d:/Codes/Major%20Project/smart-medicine-box/backend/src/main/resources/application.properties)

**关键配置**:
```properties
# 服务器配置
server.port=8080
server.servlet.context-path=/api

# 数据库配置
spring.datasource.url=jdbc:mysql://mysql:3306/smart_medicine_box?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8&connectionCollation=utf8mb4_unicode_ci
spring.datasource.username=root
spring.datasource.password=123456

# MQTT配置
mqtt.broker-url=tcp://mosquitto:1883
mqtt.client-id=backend-server
mqtt.default-qos=1

# 字符编码配置
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true
```

---

## 二、前端核心功能

### 2.1 技术栈
- **框架**: React 18
- **UI组件库**: Ant Design 5.12.0
- **HTTP客户端**: Axios
- **WebSocket**: @stomp/stompjs
- **时间处理**: dayjs
- **构建工具**: Create React App

### 2.2 核心模块

#### 2.2.1 主应用框架

**文件位置**: [App.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/App.js)

**核心功能**:
- 基于角色的菜单系统（管理员/用户）
- WebSocket连接管理
- 页面路由和导航
- 用户认证状态管理

**角色权限**:
- **管理员**: 药品管理、药格子控制、通知测试
- **用户**: 我的药品、药格子控制（简化界面）

#### 2.2.2 药品管理界面

**文件位置**: [MedicineList.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/components/MedicineList.js), [MedicineForm.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/components/MedicineForm.js)

**核心功能**:
- 药品列表展示（表格形式）
- 添加新药品
- 编辑药品信息
- 删除药品
- 启用/禁用药品（开关控件）
- 同步药品配置到设备

**药品信息字段**:
- 药品名称
- 剂量
- 服药时间（时:分）
- 药格编号（1-6）
- 启用状态

#### 2.2.3 药格子控制界面

**文件位置**: [BoxControl.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/components/BoxControl.js)

**核心功能**:
- 设备选择下拉框
- 设备在线状态显示
- 药格子编号选择（1-6）
- 打开药格子命令
- 关闭药格子命令
- 设备列表自动刷新（30秒间隔）

**操作流程**:
1. 选择药盒设备
2. 选择药格子编号
3. 点击打开/关闭按钮
4. 命令通过MQTT发送到设备

#### 2.2.4 通知组件

**文件位置**: [NotificationComponent.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/components/NotificationComponent.js)

**核心功能**:
- 实时接收WebSocket通知
- 通知铃铛图标
- 通知列表弹窗
- 通知类型标识（成功/警告/错误/信息）

#### 2.2.5 登录界面

**文件位置**: [Login.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/components/Login.js)

**核心功能**:
- 用户登录表单
- 角色识别（管理员/用户）
- 认证状态持久化

#### 2.2.6 API服务层

**文件位置**: [api.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/services/api.js)

**核心功能**:
- Axios实例配置
- 请求/响应拦截器
- API接口封装

**API模块**:
```javascript
authApi          - 认证相关API
medicineApi      - 药品管理API
nodemcuApi       - 设备控制API
offlineEventApi  - 离线事件API
notificationApi  - 通知相关API
```

#### 2.2.7 WebSocket服务

**文件位置**: [websocket.js](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/src/services/websocket.js)

**核心功能**:
- STOMP协议连接
- 主题订阅
- 消息接收处理
- 连接状态管理

**订阅主题**:
```
/topic/notifications              - 全局通知
/topic/device/{deviceId}/notifications - 设备特定通知
```

### 2.3 部署配置

**文件位置**: [nginx.conf](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/nginx.conf), [Dockerfile](file:///d:/Codes/Major%20Project/smart-medicine-box/frontend/Dockerfile)

**Nginx配置**:
- 静态资源服务
- API反向代理到后端
- WebSocket代理支持

---

## 三、设备端核心功能

### 3.1 NodeMCU ESP8266模块

**文件位置**: [esp8266.ino](file:///d:/Codes/Major%20Project/smart-medicine-box/device-end/esp8266/esp8266.ino)

#### 3.1.1 硬件功能
- **WiFi连接**: 连接本地WiFi网络
- **MQTT通信**: 与Mosquitto Broker通信
- **OLED显示**: 128x64 SSD1306显示屏
- **串口通信**: 与Arduino Uno通信

#### 3.1.2 核心功能

**1. 网络连接**
- WiFi自动连接和重连
- NTP时间同步（pool.ntp.org）
- MQTT Broker连接和重连
- 设备ID基于MAC地址生成

**2. MQTT消息处理**
- 订阅配置主题：`medicinebox/{deviceId}/config`
- 订阅命令主题：`medicinebox/{deviceId}/command`
- 订阅广播主题：`medicinebox/broadcast`
- 发布状态到：`medicinebox/{deviceId}/status`
- 发布事件到：`medicinebox/{deviceId}/events`

**3. 药品配置同步**
- 接收JSON格式的药品配置
- 解析并更新本地药品数组
- 转发配置到Arduino
- 支持最多6个药品配置

**4. 命令执行**
- OPEN_BOX - 打开指定药格
- CLOSE_BOX - 关闭指定药格
- TEST_BUZZER - 测试蜂鸣器（支持多级）
- GET_STATUS - 获取设备状态
- REBOOT - 重启设备
- GET_CONFIG - 获取当前配置
- SWITCH_BOX - 切换当前药格
- SET_OFFLINE_MODE - 设置离线模式

**5. 服药提醒**
- 实时检查服药时间
- 三级提醒机制：
  - 级别1：服药时间到，轻度提醒
  - 级别2：30分钟后未服药，中度提醒
  - 级别3：1小时后未服药，重度提醒
- 发送提醒事件到MQTT

**6. OLED显示界面**
- 启动画面
- 主界面（时间、当前药品、下次服药、状态）
- WiFi连接状态画面
- 同步结果画面

**7. 串口通信**
- 与Arduino双向通信
- 转发MQTT命令到Arduino
- 接收Arduino事件并转发到MQTT
- 心跳检测（5秒间隔）

**8. 离线模式**
- WiFi连接失败自动进入离线模式
- 本地时间管理
- 基本功能保持可用

#### 3.1.3 状态管理
```cpp
- wifiConnected      // WiFi连接状态
- mqttConnected      // MQTT连接状态
- timeSynced         // 时间同步状态
- arduinoReady       // Arduino就绪状态
- emergencyMode      // 紧急模式状态
- remindLevel        // 提醒级别（0-3）
- offlineMode        // 离线模式状态
```

### 3.2 Arduino Uno模块

**文件位置**: [arduino1.ino](file:///d:/Codes/Major%20Project/smart-medicine-box/device-end/arduino1/arduino1.ino)

#### 3.2.1 硬件功能
- **舵机控制**: 2个舵机控制药格开关
- **蜂鸣器**: 有源蜂鸣器，支持多级提醒
- **LED指示**: 2个LED指示药格状态
- **按钮**: 长按/短按检测

#### 3.2.2 核心功能

**1. 药格控制**
- openBox(int boxNum) - 打开指定药格
- closeBox(int boxNum) - 关闭指定药格
- openAllBoxes() - 打开所有药格
- closeAllBoxes() - 关闭所有药格
- 舵机角度：0°（关闭）/ 90°（打开）

**2. 提醒系统**
- 三级提醒机制：
  - 级别1：每5秒蜂鸣200ms，LED闪烁
  - 级别2：每2秒蜂鸣500ms，LED闪烁
  - 级别3：连续蜂鸣，LED快速闪烁
- 紧急模式：连续蜂鸣，LED交替闪烁

**3. 按钮交互**
- 短按（<1秒）：
  - 提醒状态下：确认服药
  - 空闲状态下：切换药格
- 长按（>3秒）：
  - 触发/取消紧急状态

**4. 串口命令处理**
```
OPEN1/OPEN2       - 打开药格1/2
CLOSE1/CLOSE2     - 关闭药格1/2
BUZZ:1/2/3        - 设置提醒级别
BUZZ_OFF          - 停止所有提醒
SET_BOX:1/2       - 切换当前药格
TAKEN             - 确认服药
EMERGENCY         - 触发紧急状态
UPDATE_CONFIG     - 准备配置更新
CONFIG:{data}     - 接收配置数据
GET_CONFIG        - 发送当前配置
```

**5. 状态机**
```cpp
STATE_IDLE              // 空闲状态
STATE_REMIND_LEVEL1     // 提醒级别1
STATE_REMIND_LEVEL2     // 提醒级别2
STATE_REMIND_LEVEL3     // 提醒级别3
STATE_EMERGENCY         // 紧急状态
STATE_MEDICINE_TAKEN    // 服药确认
STATE_MANUAL_OPEN       // 手动打开
STATE_MANUAL_CLOSE      // 手动关闭
STATE_UPDATING_CONFIG   // 配置更新中
```

**6. 药品配置管理**
- 支持最多6个药品配置
- 配置包含：名称、剂量、时间、药格、启用状态
- 默认配置预加载
- 支持配置更新和解析

**7. 音效系统**
- playToggleTone() - 切换音效
- playConfirmTone() - 确认音效
- playCancelTone() - 取消音效
- playUpdateSuccessTone() - 更新成功音效

**8. 心跳机制**
- 每5秒发送心跳（HBT）
- NodeMCU心跳检测（30秒超时）

#### 3.2.3 引脚定义
```cpp
SERVO1_PIN    9   // 舵机1 - 药格1
SERVO2_PIN    8   // 舵机2 - 药格2
BUZZER_PIN   10   // 有源蜂鸣器
LED1_PIN     11   // 红色LED - 药格1指示
LED2_PIN     7    // 绿色LED - 药格2指示
BUTTON_PIN   12   // 按钮（内部上拉）
```

---

## 四、代理端核心功能

### 4.1 Mosquitto MQTT Broker

**配置文件**: [mosquitto.conf](file:///d:/Codes/Major%20Project/smart-medicine-box/docker/mosquitto/mosquitto.conf)

#### 4.1.1 核心配置
```conf
# 监听所有网络接口
listener 1883 0.0.0.0

# 允许匿名连接（开发环境）
allow_anonymous true

# WebSocket配置
listener 9001
protocol websockets
allow_anonymous true

# 日志设置
log_dest stdout
log_type all
log_timestamp true
```

#### 4.1.2 端口说明
- **1883**: MQTT协议端口（设备连接）
- **9001**: WebSocket端口（前端连接）

#### 4.1.3 主题设计
```
# 配置同步
medicinebox/{deviceId}/config

# 命令控制
medicinebox/{deviceId}/command

# 状态上报
medicinebox/{deviceId}/status

# 事件上报
medicinebox/{deviceId}/events

# 响应消息
medicinebox/{deviceId}/response

# 广播消息
medicinebox/broadcast
```

#### 4.1.4 消息流程
1. **配置同步**: 后端 → MQTT → 设备
2. **命令控制**: 前端 → 后端 → MQTT → 设备
3. **状态上报**: 设备 → MQTT → 后端
4. **事件上报**: 设备 → MQTT → 后端 → WebSocket → 前端
5. **广播消息**: 后端 → MQTT → 所有设备

---

## 五、部署架构

### 5.1 Docker Compose编排

**配置文件**: [docker-compose.yml](file:///d:/Codes/Major%20Project/smart-medicine-box/docker-compose.yml)

#### 5.1.1 服务组件

**1. MySQL数据库**
- 镜像: mysql:8.0
- 端口: 3306
- 数据库: smart_medicine_box
- 字符集: utf8mb4_unicode_ci
- 数据持久化: Docker卷
- 初始化脚本: [init.sql](file:///d:/Codes/Major%20Project/smart-medicine-box/docker/mysql/init.sql)

**2. Mosquitto MQTT Broker**
- 镜像: eclipse-mosquitto:2.0
- 端口: 1883 (MQTT), 9001 (WebSocket)
- 配置文件挂载

**3. 后端服务**
- 镜像: 自定义构建
- 端口: 8080
- 上下文路径: /api
- 依赖: MySQL (健康检查), Mosquitto

**4. 前端应用**
- 镜像: 自定义构建
- 端口: 80
- 基础镜像: nginx:alpine
- 依赖: 后端服务

#### 5.1.2 网络架构
```
smart-medicine-box-network (bridge网络)
  ├── mysql
  ├── mosquitto
  ├── backend
  └── frontend
```

#### 5.1.3 部署命令
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build
```

### 5.2 访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端应用 | http://localhost | React应用 |
| 后端API | http://localhost:8080/api | RESTful API |
| MQTT Broker | tcp://localhost:1883 | MQTT协议 |
| MQTT WebSocket | ws://localhost:9001 | WebSocket协议 |
| MySQL | localhost:3306 | 数据库 |

### 5.3 环境变量

**后端环境变量**:
```bash
SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/smart_medicine_box?...
SPRING_DATASOURCE_USERNAME=root
SPRING_DATASOURCE_PASSWORD=123456
MQTT_BROKER_URL=tcp://mosquitto:1883
```

---

## 六、数据流程

### 6.1 药品配置同步流程

```
1. 用户在前端添加/编辑药品
   ↓
2. 前端调用 POST /api/medicines
   ↓
3. 后端保存到MySQL数据库
   ↓
4. 用户点击"同步到NodeMCU"
   ↓
5. 前端调用 POST /api/nodemcu/sync?deviceId=xxx
   ↓
6. 后端从数据库获取启用的药品
   ↓
7. 后端通过MQTT发送配置到设备
   主题: medicinebox/{deviceId}/config
   消息: {"type":"SYNC_MEDICINES","medicines":[...]}
   ↓
8. NodeMCU接收并解析配置
   ↓
9. NodeMCU通过串口发送配置到Arduino
   ↓
10. Arduino更新本地药品配置
   ↓
11. NodeMCU发送同步成功响应
```

### 6.2 服药提醒流程

```
1. NodeMCU每秒检查服药时间
   ↓
2. 匹配到服药时间
   ↓
3. NodeMCU发送提醒命令到Arduino
   串口: BUZZ:1
   ↓
4. Arduino启动提醒（蜂鸣器+LED）
   ↓
5. NodeMCU发送提醒事件到MQTT
   主题: medicinebox/{deviceId}/events
   消息: {"type":"MEDICINE_REMINDER",...}
   ↓
6. 后端接收MQTT事件
   ↓
7. 后端通过WebSocket推送到前端
   主题: /topic/notifications
   ↓
8. 前端显示服药提醒通知
   ↓
9. 用户短按按钮确认服药
   ↓
10. Arduino停止提醒，打开药格
   ↓
11. Arduino发送确认消息到NodeMCU
    串口: TAKEN
   ↓
12. NodeMCU发送服药确认事件到MQTT
    ↓
13. 后端记录服药事件
   ↓
14. 前端收到服药确认通知
```

### 6.3 药格子控制流程

```
1. 用户在前端选择设备和药格
   ↓
2. 用户点击"打开药格子"按钮
   ↓
3. 前端调用 POST /api/nodemcu/command
   参数: deviceId=xxx, command=OPEN_BOX, data={boxNum:1}
   ↓
4. 后端通过MQTT发送命令到设备
   主题: medicinebox/{deviceId}/command
   消息: {"type":"COMMAND","command":"OPEN_BOX","data":{"boxNum":1}}
   ↓
5. NodeMCU接收并解析命令
   ↓
6. NodeMCU通过串口发送命令到Arduino
   串口: OPEN1
   ↓
7. Arduino控制舵机打开药格1
   ↓
8. Arduino发送响应到NodeMCU
   串口: OK:OPEN1
   ↓
9. NodeMCU发送命令执行结果到MQTT
   ↓
10. 前端收到执行结果通知
```

### 6.4 设备离线检测流程

```
1. 设备每5秒发送心跳到MQTT
   主题: medicinebox/{deviceId}/status
   ↓
2. 后端更新设备最后活跃时间
   ↓
3. 后端每分钟检查设备状态
   ↓
4. 如果超过60秒无心跳，标记为离线
   ↓
5. 后端触发设备离线事件
   ↓
6. 后端通过WebSocket推送离线通知
   ↓
7. 前端显示设备离线警告
   ↓
8. 设备重新上线时，触发上线事件
   ↓
9. 前端显示设备在线通知
```

---

## 七、数据库设计

### 7.1 药品表 (medicines)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(50) | 药品名称 |
| dosage | VARCHAR(20) | 剂量 |
| hour | INT | 服药小时（0-23） |
| minute | INT | 服药分钟（0-59） |
| box_num | INT | 药格编号（1-2） |
| enabled | BOOLEAN | 是否启用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 7.2 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，自增 |
| username | VARCHAR(50) | 用户名（唯一） |
| password | VARCHAR(255) | 密码 |
| name | VARCHAR(50) | 姓名 |
| role | VARCHAR(20) | 角色（ADMIN/USER） |
| enabled | BOOLEAN | 是否启用 |
| phone | VARCHAR(11) | 电话 |
| email | VARCHAR(100) | 邮箱 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 7.3 离线事件表 (offline_events)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，自增 |
| device_id | VARCHAR(50) | 设备ID |
| event_time | DATETIME | 事件时间 |
| event_type | VARCHAR(50) | 事件类型 |
| event_data | TEXT | 事件数据（JSON） |
| processed | BOOLEAN | 是否已处理 |
| description | VARCHAR(200) | 事件描述 |
| created_at | TIMESTAMP | 创建时间 |

---

## 八、安全考虑

### 8.1 当前安全措施
- MySQL密码配置
- Docker网络隔离
- CORS配置

### 8.2 生产环境建议
- 禁用Mosquitto匿名连接，配置用户名密码
- 启用HTTPS/TLS
- 使用JWT进行用户认证
- 配置防火墙规则
- 定期备份数据库
- 敏感信息使用环境变量

---

## 九、扩展性设计

### 9.1 水平扩展
- 后端服务可多实例部署
- MQTT Broker支持集群模式
- 数据库支持主从复制

### 9.2 功能扩展
- 支持多设备管理
- 添加服药记录统计
- 集成短信/邮件提醒
- 添加家属监护功能
- 支持语音交互
- 添加药品库存管理

---

## 十、故障排查

### 10.1 常见问题

**1. 设备无法连接MQTT**
- 检查Mosquitto服务状态
- 确认MQTT Broker地址正确
- 检查网络连通性
- 查看设备日志

**2. 前端无法连接后端**
- 检查后端服务状态
- 确认API地址正确
- 检查Nginx配置
- 查看浏览器控制台错误

**3. 数据库连接失败**
- 检查MySQL服务状态
- 确认数据库连接信息
- 检查字符集配置
- 查看后端日志

**4. WebSocket连接失败**
- 检查后端WebSocket配置
- 确认WebSocket端点正确
- 检查网络代理设置

---

## 十一、开发指南

### 11.1 后端开发
```bash
cd backend
mvn clean install
mvn spring-boot:run
```

### 11.2 前端开发
```bash
cd frontend
npm install
npm start
```

### 11.3 设备开发
- Arduino: 使用Arduino IDE上传代码
- NodeMCU: 使用Arduino IDE（ESP8266开发板）上传代码

---

## 十二、总结

智能药盒系统通过前后端分离架构、MQTT消息队列、WebSocket实时通信等技术，实现了药品管理、服药提醒、设备控制等核心功能。系统具有良好的扩展性和可维护性，适合作为智能医疗辅助系统的参考实现。

**核心优势**:
- 实时性强（MQTT + WebSocket）
- 可靠性高（离线模式、心跳检测）
- 易于部署（Docker Compose）
- 用户友好（React + Ant Design）
- 功能完整（药品管理、提醒、控制）

**适用场景**:
- 老年人居家用药管理
- 慢性病患者用药提醒
- 医疗机构用药监护
- 家庭医疗辅助系统
