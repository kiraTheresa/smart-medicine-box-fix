# 智能药盒系统文档

## 1. 系统概述

智能药盒系统是一个基于ESP8266和Arduino Uno的物联网设备，用于帮助用户管理和服用药品。系统通过MQTT协议实现设备与云端的通信，支持远程控制和状态监控。

### 1.1 主要功能

- 药品管理与提醒
- 药格开关控制
- 远程命令发送
- 状态实时监控
- 紧急情况处理
- 药格切换功能

## 2. 硬件架构

### 2.1 开发板

- **主控板**：NodeMCU ESP8266
- **执行板**：Arduino Uno

### 2.2 设备连接

#### Arduino Uno 引脚连接

| 引脚号 | 功能 | 设备 | 备注 |
|-------|------|------|------|
| 9 | 舵机控制 | 舵机1（药格1） | 控制药格1的开关 |
| 8 | 舵机控制 | 舵机2（药格2） | 控制药格2的开关 |
| 10 | 蜂鸣器控制 | 有源蜂鸣器 | 用于发出提醒和警报 |
| 11 | LED指示 | 红色LED | 药格1状态指示 |
| 7 | LED指示 | 绿色LED | 药格2状态指示 |
| 12 | 按钮输入 | 按钮 | 用于切换药格和确认服药 |
| 0（RX） | 串口接收 | ESP8266 TX | 与ESP8266通信 |
| 1（TX） | 串口发送 | ESP8266 RX | 与ESP8266通信 |
| GND | 接地 | 所有设备 | 共地连接 |
| 5V/3.3V | 电源 | 根据设备需求 | 为舵机、LED、蜂鸣器供电 |

#### ESP8266 (NodeMCU) 引脚连接

| 引脚号 | 功能 | 设备 | 备注 |
|-------|------|------|------|
| 15 | OLED CS | OLED显示屏 | SPI通信片选信号 |
| 16 | OLED DC | OLED显示屏 | SPI通信数据/命令选择 |
| 0 | OLED RST | OLED显示屏 | 显示屏复位信号 |
| 1（TX） | 串口发送 | Arduino RX | 与Arduino通信 |
| 3（RX） | 串口接收 | Arduino TX | 与Arduino通信 |
| GND | 接地 | 所有设备 | 共地连接 |
| 3.3V | 电源 | OLED显示屏 | 为显示屏供电 |

## 3. 软件架构

### 3.1 系统组成

- **设备端**：ESP8266 + Arduino Uno
- **云端**：Spring Boot后端 + MySQL数据库
- **前端**：React单页应用
- **通信协议**：MQTT + WebSocket

### 3.2 设备端软件

#### ESP8266 功能

- MQTT通信
- OLED显示
- 时间同步
- 命令转发
- 状态上报

#### Arduino Uno 功能

- 舵机控制
- 蜂鸣器驱动
- LED指示
- 按钮处理
- 紧急状态触发

### 3.3 后端软件

#### 主要模块

- 药品管理
- 设备管理
- MQTT服务
- 用户认证
- 离线事件处理

#### 技术栈

- Java Spring Boot
- MySQL
- MQTT Broker (Mosquitto)
- Docker

### 3.4 前端软件

#### 主要功能

- 药品配置
- 设备控制
- 状态监控
- 通知提醒

#### 技术栈

- React
- Ant Design
- Axios
- WebSocket

## 4. 通信流程

### 4.1 MQTT主题

| 主题 | 功能 |
|------|------|
| medicinebox/{deviceId}/config | 设备配置同步 |
| medicinebox/{deviceId}/command | 设备命令发送 |
| medicinebox/{deviceId}/status | 设备状态上报 |
| medicinebox/{deviceId}/response | 设备响应消息 |
| medicinebox/broadcast | 广播消息 |

### 4.2 命令类型

| 命令 | 功能 | 参数 |
|------|------|------|
| OPEN_BOX | 打开药格 | boxNum: 药格编号 |
| CLOSE_BOX | 关闭药格 | boxNum: 药格编号 |
| SWITCH_BOX | 切换药格 | boxNum: 药格编号 |
| TEST_BUZZER | 测试蜂鸣器 | level: 蜂鸣器级别 |
| GET_STATUS | 获取设备状态 | 无 |
| REBOOT | 重启设备 | 无 |
| GET_CONFIG | 获取设备配置 | 无 |

## 5. 药格切换功能

### 5.1 硬件实现

- **按钮短按**：切换当前药格（1→2→1循环）
- **LED指示**：对应药格的LED灯亮起
- **蜂鸣器反馈**：切换时发出提示音

### 5.2 软件实现

#### 前端

- 命令选择：切换药格
- 药格编号选择：1-6
- 命令发送：通过MQTT发送到设备

#### 设备端

- ESP8266接收命令
- 转发到Arduino
- Arduino执行药格切换
- 更新状态并上报

## 6. 安装与配置

### 6.1 硬件组装

1. 连接Arduino和ESP8266的串口
2. 连接舵机、蜂鸣器、LED和按钮到Arduino
3. 连接OLED显示屏到ESP8266
4. 连接电源

### 6.2 软件配置

#### 设备端配置

1. 修改ESP8266的WiFi信息
2. 修改MQTT服务器地址
3. 上传代码到ESP8266和Arduino

#### 云端配置

1. 配置MySQL数据库
2. 配置MQTT Broker
3. 启动后端服务

#### 前端配置

1. 修改API地址
2. 启动前端服务

## 7. 使用说明

### 7.1 设备操作

- **短按按钮**：切换药格
- **长按按钮**：触发/取消紧急状态
- **服药提醒时短按**：确认服药

### 7.2 远程控制

1. 登录前端系统
2. 选择设备
3. 选择命令类型
4. 选择药格编号
5. 发送命令

## 8. 故障排除

### 8.1 设备连接问题

- 检查WiFi连接
- 检查MQTT服务器地址
- 检查串口连接

### 8.2 药格不动作

- 检查舵机连接
- 检查电源
- 检查命令格式

### 8.3 显示异常

- 检查OLED连接
- 检查SPI引脚

## 9. 系统扩展

### 9.1 增加药格数量

- 修改Arduino代码中的引脚定义
- 增加舵机和LED
- 更新前端药格选择

### 9.2 添加新功能

- 语音提醒
- 指纹识别
- 摄像头监控

## 10. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| V1.0 | 2024-01-13 | 初始版本 |
| V1.1 | 2024-01-13 | 添加药格切换功能 |

## 11. 注意事项

- 设备需定期检查电源
- 药品信息需及时更新
- 紧急按钮需妥善保管
- 定期备份数据库

## 12. 联系方式

如有问题或建议，请联系开发团队。
