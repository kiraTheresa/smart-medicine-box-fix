# 智能药盒设备连接示意图

## 1. 系统连接总览

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端应用                                 │
└─────────────────┬─────────────────────────────────────────────────┘
                  │ HTTP/WebSocket
┌─────────────────▼─────────────────────────────────────────────────┐
│                         后端服务                                 │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────┐ │
│  │ 药品管理     │  │ 设备管理     │  │ MQTT服务     │  │ 数据库│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────┘ │
└─────────────────┬─────────────────────────────────────────────────┘
                  │ MQTT
┌─────────────────▼─────────────────────────────────────────────────┐
│                      ESP8266 (NodeMCU)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ MQTT客户端   │  │ OLED显示     │  │ 时间同步     │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└─────────────────┬─────────────────────────────────────────────────┘
                  │ 串口通信
┌─────────────────▼─────────────────────────────────────────────────┐
│                       Arduino Uno                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────┐ │
│  │ 舵机控制     │  │ 蜂鸣器驱动   │  │ LED指示      │  │ 按钮处理│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────┘ │
└─────────────────┬─────────────────────────────────────────────────┘
                  │ 硬件控制
┌─────────────────┼─────────────────┬─────────────────┬─────────────┐
│                 │                 │                 │             │
│  ┌───────────┐  │  ┌───────────┐  │  ┌───────────┐  │  ┌───────┐  │
│  │ 舵机1     │  │  │ 舵机2     │  │  │ 蜂鸣器    │  │  │ 按钮  │  │
│  └───────────┘  │  └───────────┘  │  └───────────┘  │  └───────┘  │
│  ┌───────────┐  │  ┌───────────┐  │                 │             │
│  │ LED1      │  │  │ LED2      │  │                 │             │
│  └───────────┘  │  └───────────┘  │                 │             │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
```

## 2. Arduino Uno 引脚连接详图

| 引脚 | 连接设备 | 方向 | 功能描述 |
|------|----------|------|----------|
| 9    | 舵机1信号线 | 输出 | 控制药格1开关 |
| 8    | 舵机2信号线 | 输出 | 控制药格2开关 |
| 10   | 蜂鸣器正极  | 输出 | 驱动蜂鸣器发声 |
| 11   | LED1正极   | 输出 | 药格1状态指示 |
| 7    | LED2正极   | 输出 | 药格2状态指示 |
| 12   | 按钮一端    | 输入 | 按钮信号输入 |
| 0 (RX) | ESP8266 TX | 输入 | 接收ESP8266数据 |
| 1 (TX) | ESP8266 RX | 输出 | 发送数据到ESP8266 |
| GND  | 所有设备负极 | 接地 | 系统共地 |
| 5V   | 舵机电源正极 | 电源 | 为舵机供电 |
| 3.3V | LED/蜂鸣器电源 | 电源 | 为LED和蜂鸣器供电 |

## 3. ESP8266 (NodeMCU) 引脚连接详图

| 引脚 | 连接设备 | 方向 | 功能描述 |
|------|----------|------|----------|
| D8 (GPIO15) | OLED CS | 输出 | SPI片选信号 |
| D0 (GPIO16) | OLED DC | 输出 | 数据/命令选择 |
| D3 (GPIO0)  | OLED RST | 输出 | 显示屏复位 |
| D1 (GPIO5)  | OLED SCL | 输出 | SPI时钟信号 |
| D2 (GPIO4)  | OLED SDA | 输出 | SPI数据信号 |
| TX (GPIO1)  | Arduino RX | 输出 | 发送数据到Arduino |
| RX (GPIO3)  | Arduino TX | 输入 | 接收Arduino数据 |
| GND  | Arduino GND | 接地 | 系统共地 |
| 3.3V | OLED VCC | 电源 | 为OLED供电 |

## 4. 外设连接说明

### 4.1 舵机连接

- **舵机1**：控制药格1的开关
  - 红色线 → Arduino 5V
  - 棕色线 → Arduino GND
  - 橙色线 → Arduino 9号引脚

- **舵机2**：控制药格2的开关
  - 红色线 → Arduino 5V
  - 棕色线 → Arduino GND
  - 橙色线 → Arduino 8号引脚

### 4.2 蜂鸣器连接

- **有源蜂鸣器**
  - 正极 → Arduino 10号引脚
  - 负极 → Arduino GND

### 4.3 LED指示灯连接

- **LED1（红色）**：药格1状态指示
  - 正极 → Arduino 11号引脚
  - 负极 → Arduino GND（串联220Ω电阻）

- **LED2（绿色）**：药格2状态指示
  - 正极 → Arduino 7号引脚
  - 负极 → Arduino GND（串联220Ω电阻）

### 4.4 按钮连接

- **按钮**：用于切换药格和确认服药
  - 一端 → Arduino 12号引脚
  - 另一端 → Arduino GND
  - 使用内部上拉电阻

### 4.5 OLED显示屏连接

- **OLED 128x64**：显示时间、药品信息等
  - VCC → ESP8266 3.3V
  - GND → ESP8266 GND
  - SCL → ESP8266 D1 (GPIO5)
  - SDA → ESP8266 D2 (GPIO4)
  - CS → ESP8266 D8 (GPIO15)
  - DC → ESP8266 D0 (GPIO16)
  - RST → ESP8266 D3 (GPIO0)

## 5. 电源连接建议

### 5.1 电源需求

- **舵机**：每个舵机工作电流约200-300mA，建议使用5V 1A以上电源
- **ESP8266**：工作电流约100-200mA，建议使用3.3V稳压电源
- **Arduino**：工作电流约50-100mA，建议使用5V电源
- **OLED**：工作电流约10-20mA，使用3.3V电源
- **LED/蜂鸣器**：工作电流约10-50mA，可使用5V或3.3V电源

### 5.2 电源连接方案

1. **方案一**：使用外部开关电源
   - 5V 2A开关电源 → Arduino Vin引脚
   - Arduino 3.3V引脚 → ESP8266 3.3V引脚
   - 共地连接

2. **方案二**：使用电池供电
   - 6V电池 → Arduino Vin引脚
   - Arduino 3.3V引脚 → ESP8266 3.3V引脚
   - 共地连接

3. **注意事项**
   - 舵机启动时电流较大，建议使用单独的电源供电
   - 所有设备必须共地
   - 电源电压必须稳定，避免电压波动影响设备工作

## 6. 通信协议

### 6.1 设备间通信

| 通信方式 | 速率 | 传输方向 | 用途 |
|----------|------|----------|------|
| 串口通信 | 9600bps | 双向 | ESP8266 ↔ Arduino |
| SPI通信 | 4MHz | 单向 | ESP8266 → OLED |
| MQTT | - | 双向 | 后端 ↔ ESP8266 |
| HTTP | - | 双向 | 前端 ↔ 后端 |
| WebSocket | - | 双向 | 前端 ↔ 后端 |

### 6.2 串口命令格式

| 命令 | 格式 | 示例 |
|------|------|------|
| 打开药格 | OPEN{num} | OPEN1 |
| 关闭药格 | CLOSE{num} | CLOSE2 |
| 设置当前药格 | SET_BOX:{num} | SET_BOX:1 |
| 蜂鸣器控制 | BUZZ:{level} | BUZZ:1 |
| 紧急状态 | EMERGENCY | EMERGENCY |
| 取消紧急状态 | EMERGENCY_CANCEL | EMERGENCY_CANCEL |
| 服药确认 | TAKEN | TAKEN |
| 心跳 | PING | PING |

## 7. 安装步骤

### 7.1 硬件安装

1. **连接Arduino和ESP8266**
   - Arduino TX → ESP8266 RX
   - Arduino RX → ESP8266 TX
   - Arduino GND → ESP8266 GND

2. **连接舵机**
   - 舵机1 → Arduino 9号引脚
   - 舵机2 → Arduino 8号引脚

3. **连接蜂鸣器**
   - 蜂鸣器 → Arduino 10号引脚

4. **连接LED指示灯**
   - LED1 → Arduino 11号引脚
   - LED2 → Arduino 7号引脚

5. **连接按钮**
   - 按钮 → Arduino 12号引脚

6. **连接OLED显示屏**
   - OLED → ESP8266相应引脚

7. **连接电源**
   - 为Arduino和ESP8266供电

### 7.2 软件安装

1. **上传Arduino代码**
   - 打开Arduino IDE
   - 导入Servo库
   - 上传arduino1.ino到Arduino Uno

2. **上传ESP8266代码**
   - 打开Arduino IDE或VS Code (PlatformIO)
   - 导入所需库（ESP8266WiFi, U8g2lib, NTPClient, PubSubClient, ArduinoJson）
   - 修改WiFi和MQTT配置
   - 上传esp8266.ino到ESP8266

3. **启动后端服务**
   - 配置MySQL数据库
   - 配置MQTT Broker
   - 启动Spring Boot应用

4. **启动前端应用**
   - 安装依赖
   - 启动React应用

## 8. 测试步骤

### 8.1 设备连接测试

1. 检查所有设备连接是否正确
2. 接通电源
3. 观察OLED显示屏是否显示设备信息
4. 检查LED指示灯是否正常
5. 短按按钮，观察是否能切换药格

### 8.2 通信测试

1. 检查ESP8266是否成功连接到WiFi
2. 检查ESP8266是否成功连接到MQTT Broker
3. 从前端发送命令，观察设备是否响应
4. 观察设备状态是否能实时上报到前端

### 8.3 功能测试

1. 测试药格开关功能
2. 测试药格切换功能
3. 测试蜂鸣器功能
4. 测试紧急状态功能
5. 测试药品提醒功能

## 9. 故障排除

### 9.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| OLED不显示 | 电源问题或引脚连接错误 | 检查电源连接和引脚接线 |
| 舵机不动作 | 电源问题或引脚连接错误 | 检查电源连接和引脚接线 |
| 设备无法连接到MQTT | WiFi或MQTT配置错误 | 检查WiFi和MQTT配置 |
| 前端无法控制设备 | 后端服务未启动或MQTT连接失败 | 检查后端服务和MQTT连接 |
| 按钮不响应 | 引脚连接错误或代码问题 | 检查引脚连接和代码 |

### 9.2 调试技巧

1. 使用Arduino IDE的串口监视器查看串口通信
2. 在ESP8266代码中添加调试信息
3. 检查MQTT Broker日志
4. 检查后端服务日志
5. 使用前端浏览器开发者工具查看网络请求

## 10. 注意事项

1. **电源安全**
   - 确保电源电压符合设备要求
   - 避免短路
   - 定期检查电源连接

2. **设备安全**
   - 避免设备进水
   - 避免设备受到强烈震动
   - 定期检查设备连接

3. **软件安全**
   - 定期更新设备固件
   - 确保MQTT密码安全
   - 定期备份数据库

4. **使用安全**
   - 按钮按压力度适中，避免损坏按钮
   - 避免在设备工作时触摸舵机等运动部件
   - 紧急状态按钮仅在紧急情况下使用

## 11. 扩展建议

1. **增加药格数量**
   - 添加更多舵机和LED
   - 修改代码支持更多药格

2. **添加语音提醒**
   - 连接语音模块
   - 修改代码支持语音提醒

3. **添加摄像头监控**
   - 连接摄像头模块
   - 添加图像传输功能

4. **添加指纹识别**
   - 连接指纹模块
   - 添加身份验证功能

5. **添加蓝牙控制**
   - 连接蓝牙模块
   - 添加蓝牙控制功能

## 12. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| V1.0 | 2024-01-13 | 初始版本 |
| V1.1 | 2024-01-13 | 添加药格切换功能 |

## 13. 联系方式

如有问题或建议，请联系开发团队。
