### 1. 项目整体架构

- 前端层 ：React应用，提供用户界面和设备管理功能
- 后端层 ：Spring Boot应用，负责业务逻辑和MQTT通信
- MQTT通信层 ：Mosquitto服务器，负责设备与后端的消息传递
- 设备端 ：ESP8266 + Arduino，负责药盒的物理控制

### 2. 核心实现层次 前端层

- NodeMCUSync组件 ：提供设备选择、配置同步和命令发送功能
  - 自动检测在线设备
  - 支持手动选择设备ID
  - 提供"同步配置"和"发送命令"功能
  - 支持查看和复制配置代码
- api.js ：封装与后端的HTTP通信接口
  - 药品管理API
  - NodeMCU设备管理API
  - 命令发送API 后端层
- NodeMCUController ：处理前端请求
  - /nodemcu/config ：生成设备配置代码
  - /nodemcu/sync ：处理配置同步请求
  - /nodemcu/command ：转发命令到设备
  - /nodemcu/devices ：获取在线设备列表
- MqttService ：MQTT通信核心服务
  - syncMedicinesToDevice ：同步药品配置到设备
  - sendCommand ：发送命令到设备
  - updateDeviceStatus ：更新设备在线状态
  - broadcast ：广播消息到所有设备
- MqttGateway ：MQTT消息发送接口
- MQTT配置 ：
  - MqttConfig：MQTT连接配置
  - MqttIntegrationConfig：消息通道和适配器配置 MQTT通信层
- 主题设计 ：
  - medicinebox/+/status ：设备状态上报
  - medicinebox/{deviceId}/config ：设备配置同步
  - medicinebox/{deviceId}/command ：命令发送
  - medicinebox/broadcast ：广播消息
- 消息格式 ：JSON格式，包含消息类型、设备ID、数据内容等 设备端
- ESP8266 ：负责MQTT连接、消息接收和命令执行
- Arduino ：负责药盒的物理控制（电机驱动、蜂鸣器控制等）

### 3. 数据同步流程

1. 前端通过HTTP请求获取设备列表和药品数据
2. 前端发送同步请求到后端
3. 后端调用 MqttService.syncMedicinesToDevice 生成MQTT消息
4. MQTT消息通过 MqttGateway 发送到指定设备的配置主题
5. 设备接收MQTT消息，解析并更新本地配置
6. 设备定期上报状态到状态主题
7. 后端接收状态消息，更新设备在线状态

### 4. 命令执行流程

1. 前端选择设备和命令类型
2. 前端发送命令请求到后端
3. 后端调用 MqttService.sendCommand 生成MQTT命令消息
4. 命令消息通过MQTT发送到设备的命令主题
5. 设备接收命令，执行相应操作（打开药盒、测试蜂鸣器等）
6. 设备返回执行结果到状态主题

### 5. 关键技术特性

- 实时通信 ：基于MQTT协议实现设备与后端的实时通信
- 自动发现 ：后端自动检测在线设备
- 配置同步 ：支持将药品配置实时同步到设备
- 远程控制 ：支持远程发送命令控制设备
- 状态监控 ：实时监控设备在线状态

### 6. 主要文件结构

```
smart-medicine-box/
├── frontend/
│   └── src/
│       ├── components/
│       │   └── NodeMCUSync.js    # 设备同步组件
│       └── services/
│           └── api.js            # API通信封装
└── backend/
    └── src/
        └── main/
            └── java/
                └── com/ycyu/backend/
                    ├── controller/
                    │   └── NodeMCUController.java  # 设备控制API
                    ├── service/
                    │   ├── MqttService.java        # MQTT通信服务
                    │   └── MqttGateway.java        # MQTT消息网关
                    └── config/
                        ├── MqttConfig.java          # MQTT连接配置
                        └── MqttIntegrationConfig.java # MQTT消息通道配置
```

通过以上架构，实现了药盒信息的双向同步和远程操作，确保了设备与服务器之间的实时通信和数据一致性。
