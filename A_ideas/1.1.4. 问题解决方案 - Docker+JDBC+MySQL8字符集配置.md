# 1.1.4. 问题解决方案 - Docker+JDBC+MySQL8字符集配置

## 一、问题概述

在智能药箱项目中，遇到了 Docker + JDBC + MySQL8 组合的字符集问题，导致中文数据存储和显示异常，后端服务出现连接错误。

## 二、核心问题点

### 1. 字符集分层配置不一致

**问题现象**：
- MySQL 服务端和数据库已配置为 utf8mb4
- 但客户端连接协议仍使用默认的 latin1
- 初始化 SQL 脚本编码错误，导致中文数据乱码

**根本原因**：
- Docker + JDBC + MySQL8 组合在字符集默认值不可靠
- 各层级字符集配置未统一：服务端 ≠ 连接协议 ≠ 客户端 ≠ 初始化脚本

### 2. JDBC 驱动字符集限制

**问题现象**：
- 直接将 `characterEncoding` 设置为 `utf8mb4` 时，JDBC 驱动报错
- 错误信息：`Unsupported character encoding 'utf8mb4'`

**根本原因**：
- MySQL JDBC 驱动不支持直接将 `characterEncoding` 参数设置为 `utf8mb4`
- 需要设置为 `utf8`，驱动会自动映射到 `utf8mb4`

### 3. 历史数据卷污染

**问题现象**：
- 修改配置后，问题依然存在
- 数据库中文数据仍显示乱码

**根本原因**：
- 旧的数据卷包含了使用错误字符集创建的表和数据
- MySQL 不会自动重建数据库或重跑初始化脚本

### 4. 初始化脚本编码问题

**问题现象**：
- 插入中文数据时显示乱码
- 直接在数据库中插入中文数据正常

**根本原因**：
- 初始化 SQL 脚本本身编码错误（非 UTF-8）
- 执行脚本时未显式指定字符集

## 三、解决方案

### 1. 统一字符集配置

**服务端配置**：
```yaml
command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
environment:
  - MYSQL_CHARSET=utf8mb4
  - MYSQL_COLLATION=utf8mb4_unicode_ci
  - LANG=C.UTF-8
  - LC_ALL=C.UTF-8
```

**JDBC 连接配置**：
```properties
spring.datasource.url=jdbc:mysql://mysql:3306/dbname
?useUnicode=true
&characterEncoding=utf8
&connectionCollation=utf8mb4_unicode_ci
&serverTimezone=Asia/Shanghai
```

**初始化脚本配置**：
```sql
SET NAMES utf8mb4;
SET character_set_client = utf8mb4;
SET character_set_connection = utf8mb4;
SET character_set_results = utf8mb4;
```

### 2. 清理历史数据卷

```powershell
docker compose down -v
docker volume rm smart-medicine-box_mysql-data
docker compose up -d
```

### 3. 修复初始化脚本

- 重新创建 UTF-8 编码的 `init.sql` 文件
- 显式指定表和列的字符集

### 4. 优化后端配置

- 删除冗余的 Hibernate 字符集配置
- 确保 Dockerfile 中设置了 `-Dfile.encoding=UTF-8`

## 四、验证结果

### 1. 数据库字符集

```
character_set_server     = utf8mb4
character_set_database   = utf8mb4
collation_server         = utf8mb4_unicode_ci
collation_database       = utf8mb4_unicode_ci
```

### 2. 中文数据显示

| name   | dosage |
|--------|--------|
| 降压药 | 1片    |
| 降糖药 | 1粒    |
| 维生素 | 2粒    |
| 心脑通 | 1粒    |
| 钙片   | 1片    |

### 3. 后端服务状态

- 服务稳定运行，无字符集相关错误
- JDBC 连接正常，无连接池初始化异常

## 五、经验教训

1. **显式指定所有字符集**：
   - 永远不要依赖默认字符集配置
   - 在所有层级显式指定 utf8mb4

2. **注意 JDBC 驱动限制**：
   - `characterEncoding` 必须设置为 `utf8`，而非 `utf8mb4`
   - 配合 `connectionCollation=utf8mb4_unicode_ci` 确保完整支持

3. **清理历史数据**：
   - 修改字符集配置后，必须清理旧数据卷
   - 否则旧配置和数据会持续污染系统

4. **验证初始化脚本编码**：
   - 确保 SQL 脚本本身是 UTF-8 编码
   - 开头添加字符集设置命令

5. **统一各组件编码**：
   - 服务端、客户端、连接协议、初始化脚本的字符集必须一致
   - 定期检查和验证字符集配置

## 六、最佳实践

1. **使用 utf8mb4 统一字符集**：
   - 支持所有 Unicode 字符，包括 emoji
   - 避免字符截断和乱码问题

2. **JDBC URL 字符集参数模板**：
   ```
   jdbc:mysql://host:port/dbname
   ?useUnicode=true
   &characterEncoding=utf8
   &connectionCollation=utf8mb4_unicode_ci
   &serverTimezone=Asia/Shanghai
   ```

3. **初始化脚本模板**：
   ```sql
   SET NAMES utf8mb4;
   SET character_set_client = utf8mb4;
   SET character_set_connection = utf8mb4;
   SET character_set_results = utf8mb4;
   
   CREATE TABLE table_name (
       ...
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
   ```

4. **定期验证配置**：
   ```sql
   SHOW VARIABLES LIKE 'character_set%';
   SHOW VARIABLES LIKE 'collation%';
   SHOW CREATE TABLE table_name;
   ```

通过以上解决方案，成功解决了 Docker + JDBC + MySQL8 组合的字符集问题，确保了智能药箱项目中中文数据的正确存储和显示。